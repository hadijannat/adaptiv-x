# Secure profile for Adaptiv-X services with OIDC authentication.
# Usage: docker compose -f docker-compose.yml -f docker-compose.secure.yml up

services:
  keycloak:
    image: quay.io/keycloak/keycloak:24.0.4
    container_name: adaptivx-keycloak
    command: start-dev --http-port=8080 --hostname-strict=false --import-realm
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HOSTNAME: localhost
      KC_HOSTNAME_PORT: 8088
    ports:
      - "8088:8080"
    volumes:
      - ../keycloak/realm-adaptivx.json:/opt/keycloak/data/import/realm-adaptivx.json:ro
    networks:
      - adaptivx-net

  adaptiv-monitor:
    build:
      context: ../../
      dockerfile: services/adaptiv-monitor/Dockerfile
    container_name: adaptivx-monitor
    ports:
      - "8011:8000"
    environment:
      AAS_ENVIRONMENT_URL: http://aas-environment:8081
      AAS_REGISTRY_URL: http://aas-registry:8080
      SUBMODEL_REGISTRY_URL: http://submodel-registry:8080
      MQTT_BROKER_HOST: mosquitto
      MQTT_BROKER_PORT: 1883
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-adaptivx}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-adaptivx123}
      AUTH_ENABLED: "true"
      OIDC_ISSUER: http://localhost:8088/realms/adaptivx
      OIDC_AUDIENCE: adaptivx-services
      OIDC_JWKS_URL: http://keycloak:8080/realms/adaptivx/protocol/openid-connect/certs
    depends_on:
      aas-environment:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
      minio:
        condition: service_healthy
      keycloak:
        condition: service_started
    networks:
      - adaptivx-net

  skill-broker:
    build:
      context: ../../
      dockerfile: services/skill-broker/Dockerfile
    container_name: adaptivx-skill-broker
    ports:
      - "8002:8000"
    environment:
      AAS_ENVIRONMENT_URL: http://aas-environment:8081
      MQTT_BROKER_HOST: mosquitto
      MQTT_BROKER_PORT: 1883
      AUTH_ENABLED: "true"
      OIDC_ISSUER: http://localhost:8088/realms/adaptivx
      OIDC_AUDIENCE: adaptivx-services
      OIDC_JWKS_URL: http://keycloak:8080/realms/adaptivx/protocol/openid-connect/certs
    depends_on:
      aas-environment:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
      keycloak:
        condition: service_started
    networks:
      - adaptivx-net

  job-dispatcher:
    build:
      context: ../../
      dockerfile: services/job-dispatcher/Dockerfile
    container_name: adaptivx-job-dispatcher
    ports:
      - "8003:8000"
    environment:
      AAS_REGISTRY_URL: http://aas-registry:8080
      SUBMODEL_REGISTRY_URL: http://submodel-registry:8080
      MQTT_BROKER_HOST: mosquitto
      MQTT_BROKER_PORT: 1883
      AUTH_ENABLED: "true"
      OIDC_ISSUER: http://localhost:8088/realms/adaptivx
      OIDC_AUDIENCE: adaptivx-services
      OIDC_JWKS_URL: http://keycloak:8080/realms/adaptivx/protocol/openid-connect/certs
    depends_on:
      aas-environment:
        condition: service_healthy
      keycloak:
        condition: service_started
    networks:
      - adaptivx-net

  fault-injector:
    build:
      context: ../../
      dockerfile: services/fault-injector/Dockerfile
    container_name: adaptivx-fault-injector
    ports:
      - "8004:8000"
    environment:
      MONITOR_URL: http://adaptivx-monitor:8000
      BROKER_URL: http://adaptivx-skill-broker:8000
      AUTH_ENABLED: "true"
      OIDC_ISSUER: http://localhost:8088/realms/adaptivx
      OIDC_AUDIENCE: adaptivx-services
      OIDC_JWKS_URL: http://keycloak:8080/realms/adaptivx/protocol/openid-connect/certs
    depends_on:
      adaptiv-monitor:
        condition: service_started
      skill-broker:
        condition: service_started
      keycloak:
        condition: service_started
    networks:
      - adaptivx-net

  dashboard:
    build:
      context: ../../services/dashboard
      dockerfile: Dockerfile
    container_name: adaptivx-dashboard
    ports:
      - "3000:80"
    environment:
      VITE_MQTT_BROKER_URL: ws://localhost:9883
    depends_on:
      mosquitto:
        condition: service_healthy
    networks:
      - adaptivx-net
